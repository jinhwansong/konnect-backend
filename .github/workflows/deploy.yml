name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 코드 체크아웃
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    # Node.js 환경 설정
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    # 의존성 설치
    - name: Install Dependencies
      run: npm ci
    
    # 프로젝트 빌드
    - name: Build Project
      run: npm run build
    
    # SSH 키 설정
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    # 서버 배포 준비
    - name: Prepare Deployment
      run: |
        # 배포할 파일들을 압축
        tar -czvf deploy.tar.gz dist node_modules package.json package-lock.json
    
    # EC2 서버에 파일 복사
    - name: Copy files to EC2
      run: |
        scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/
    
    # 서버에서 배포 스크립트 실행
    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          cd ~/app
          
          # 기존 압축 해제된 파일 제거
          rm -rf dist node_modules package.json package-lock.json
          
          # 새 파일 압축 해제
          tar -xzvf deploy.tar.gz
          
          # 압축 파일 삭제
          rm deploy.tar.gz
          
          # PM2로 앱 시작 또는 재시작
          pm2 delete app || true
          pm2 start dist/main.js --name "app"
        EOF
